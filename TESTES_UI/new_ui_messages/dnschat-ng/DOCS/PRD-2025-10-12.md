# Product Requirements Document (PRD)

**Product Name:** DNS Chat
**Version:** 2.5
**Date:** October 12, 2025
**Document Owner:** DNSChat Team
**Status:** Active Development

## 1. Executive Summary

DNS Chat is a cross-platform mobile application (iOS, Android, Web) that enables ChatGPT-like conversational interactions with AI through DNS TXT record queries. The application leverages DNS protocol as a communication transport layer, providing a unique approach to LLM interactions with sophisticated fallback mechanisms and native performance optimizations.

## 2. Business Objectives

1. Demonstrate innovative use of DNS protocol for AI communication
2. Provide enterprise-grade reliability through multi-transport fallback chain
3. Deliver native-quality user experience with iOS 26+ Liquid Glass design system
4. Maintain cross-platform compatibility (iOS 16+, Android API 21+, Web)
5. Achieve App Store production readiness with comprehensive security and accessibility compliance

## 3. Target Users

### Primary Personas

1. **Technical Experimenters**: Developers and engineers interested in novel network protocols and DNS innovation
2. **Mobile Users**: iOS and Android users seeking lightweight AI chat interfaces
3. **Privacy-Conscious Users**: Users interested in DNS-over-HTTPS and alternative communication methods

### Use Cases

- Conversational AI interactions via DNS protocol
- Testing DNS infrastructure and transport methods
- Demonstrating DNS TXT record capabilities for custom applications
- Educational exploration of network protocols and fallback strategies

## 4. Functional Requirements

### 4.1 Chat Interface

**FR-001** The application SHALL provide a ChatGPT-like message interface with user and assistant message bubbles.
**FR-002** The application SHALL support multiple concurrent chat conversations with unique identifiers.
**FR-003** The application SHALL persist chat history locally using AsyncStorage.
**FR-004** The application SHALL allow users to create new chats and delete existing chats.
**FR-005** The application SHALL display message timestamps with localized formatting.
**FR-006** The application SHALL show loading indicators during DNS query operations.
**FR-007** The application SHALL display error messages with actionable troubleshooting guidance.
**FR-008** The application SHALL support message input with validation (max 200 characters before sanitization).
**FR-009** The application SHALL support dynamic routing with `/chat/[id]` pattern for chat detail screens.

### 4.2 DNS Transport Layer

**FR-010** The application SHALL implement multi-method DNS transport with the following fallback chain:
- Native DNS (iOS Network Framework / Android DnsResolver)
- UDP DNS (react-native-udp)
- TCP DNS (react-native-tcp-socket)

**FR-011** The application SHALL sanitize all user input following RFC 1035 DNS label constraints:
- Convert to lowercase
- Replace spaces with dashes
- Remove invalid characters (only alphanumeric and dash allowed)
- Truncate to 63 characters maximum

**FR-012** The application SHALL validate DNS servers against a whitelist (ch.at, llm.pieter.com, Google DNS, Cloudflare).
**FR-013** The application SHALL compose DNS queries as `<label>.<dns-server>` format.
**FR-014** The application SHALL parse multi-part TXT responses with `n/n:content` format.
**FR-015** The application SHALL handle duplicate TXT records from UDP retransmission correctly.
**FR-016** The application SHALL implement rate limiting (10 requests per 60-second window).
**FR-017** The application SHALL suspend DNS queries when application is backgrounded.
**FR-018** The application SHALL support configurable DNS method preferences:
- Native (prioritize native DNS)

**FR-019** The application SHALL allow users to toggle experimental transports (UDP/TCP/HTTPS) via Settings.
**FR-020** The application SHALL implement exponential backoff retry strategy (max 3 attempts).

### 4.3 Native Module Integration

**FR-021** The application SHALL provide iOS native DNS module using Swift and Network Framework (iOS 16.0+).
**FR-022** The application SHALL provide Android native DNS module using DnsResolver API (API 29+) with dnsjava fallback (API 21-28).
**FR-023** Native modules SHALL implement thread-safe continuation management to prevent double-resume crashes.
**FR-024** Native modules SHALL use bounded thread pools (2-4 threads max) to prevent resource exhaustion.
**FR-025** Native modules SHALL implement proper timeout mechanisms with atomic flags.
**FR-026** Native modules SHALL handle CheckedContinuation (iOS) and concurrent operations safely.
**FR-027** Native modules SHALL be discoverable via Expo autolinking from `modules/dns-native/` directory.
**FR-028** Native modules SHALL export consistent TypeScript interfaces for cross-platform usage.

### 4.4 User Interface and Design System

**FR-029** The application SHALL implement iOS 26+ Liquid Glass design system
**FR-030** The application SHALL provide cross-platform fallback UI rendering:
- iOS 26+: Native UIVisualEffectView with liquid glass
- iOS 16-25: Enhanced blur effects
- Android: Material Design 3 elevated surfaces
- Web: CSS glassmorphism with backdrop-filter

**FR-031** The application SHALL use native bottom tabs:
- Chat List (home icon, chat count badge)
- Search (system search integration)
- DNS Logs (clipboard icon)
- About (info circle icon)

**FR-032** The application SHALL implement SF Symbols for iOS native iconography.
**FR-033** The application SHALL respect iOS minimize behavior (auto-hide tab bar on scroll down).
**FR-034** The application SHALL support DynamicColorIOS for accessibility (high contrast modes).
**FR-035** The application SHALL implement automatic dark/light theme switching based on system preferences.
**FR-036** The application SHALL use StyleSheet.create for all component styling (no inline styles).
**FR-037** The application SHALL limit glass effects to 5-10 elements per screen for performance on older iphones.
**FR-038** The application SHALL disable glass effects during heavy animations/scrolling.
**FR-039** The application SHALL use FlashList (@shopify/flash-list) for lists with 10+ items.

### 4.5 Settings and Configuration

**FR-040** The application SHALL provide Settings screen with the following configuration options:
- DNS service selection (ch.at, llm.pieter.com)
- Theme selection (auto, light, dark)
- Language selection (en-US, pt-BR)

**FR-041** The application SHALL persist settings using sqlite if possible or AsyncStorage.
**FR-042** The application SHALL provide DNS transport test functionality for each method.
**FR-043** The application SHALL implement throttling for DNS diagnostic tests (1200ms minimum interval).
**FR-044** The application SHALL validate settings changes before applying.
**FR-045** The application SHALL provide "Reset Onboarding" option for developers.

### 4.6 Logging and Diagnostics

**FR-046** The application SHALL maintain a comprehensive DNS query log with the following information:
- Query timestamp
- DNS method attempted
- Target server
- Query name (label.server)
- Response time (milliseconds)
- Success/failure status
- Error details (if failed)

**FR-047** The application SHALL provide a dedicated DNS Logs tab for viewing query history.
**FR-048** The application SHALL support log filtering by method and status.
**FR-049** The application SHALL implement DNSLogService for centralized logging.
**FR-050** The application SHALL provide detailed fallback chain visualization in logs.
**FR-051** The application SHALL log all method attempts, successes, and failures.
**FR-052** The application SHALL wrap production console.log statements in `__DEV__` guards.

### 4.7 Internationalization (i18n)

**FR-053** The application SHALL support multiple languages with type-safe translation keys.
**FR-054** The application SHALL implement a 3-tier locale resolution fallback chain:
1. User-selected locale
2. System device locale
3. Default locale (en-US)

**FR-055** The application SHALL provide complete translations for:
- en-US (English - United States)
- pt-BR (Portuguese - Brazil)

**FR-056** The application SHALL normalize locale variants (en-US, pt-BR).
**FR-057** The application SHALL expose useTranslation() hook for component localization.
**FR-058** The application SHALL translate all UI text including:
- Tab labels
- Button text
- Form labels
- Error messages
- Settings options
- Onboarding screens

### 4.8 Onboarding Experience

**FR-059** The application SHALL provide an interactive onboarding flow with the following screens:
- Welcome screen (app introduction)
- DNS demonstration screen (live DNS query example)
- Feature showcase screens (highlighting key capabilities)
- Completion screen (redirect to main app)

**FR-060** The application SHALL use real DNS methods in onboarding (not mock service).
**FR-061** The application SHALL track onboarding completion status in AsyncStorage.
**FR-062** The application SHALL redirect authenticated users to chat list after onboarding.
**FR-063** The application SHALL support scrollable onboarding content for smaller screens.

## 5. Non-Functional Requirements

### 5.1 Performance

**NFR-001** The application SHALL achieve 60fps rendering on all supported devices.
**NFR-002** DNS queries SHALL complete within 10 seconds (timeout threshold).
**NFR-003** Native DNS methods SHALL be prioritized for optimal query performance.
**NFR-004** The application SHALL implement React Compiler for automatic memoization.
**NFR-005** The application SHALL use React Native New Architecture (Fabric + TurboModules).
**NFR-006** The application SHALL limit glass effects to prevent performance degradation on older iphone.
**NFR-007** The application SHALL use FlashList for optimized list rendering (10x better than FlatList).
**NFR-008** The application SHALL implement proper cleanup for native module resources.

### 5.2 Security

**NFR-009** The application SHALL validate all user input to prevent DNS injection attacks.
**NFR-010** The application SHALL reject control characters (\\x00-\\x1F, \\x7F-\\x9F) in messages.
**NFR-011** The application SHALL whitelist DNS servers to prevent query redirection.
**NFR-012** The application SHALL validate DNS server hostnames and IP addresses
**NFR-013** The application SHALL enforce RFC 1035 DNS label constraints (63 char max).
**NFR-014** The application SHALL implement rate limiting to prevent abuse (10 req/60s).
**NFR-015** The application SHALL have zero npm security vulnerabilities.
**NFR-016** The application SHALL comply with OWASP ASVS 5.0 Level 1 standards.
**NFR-017** The application SHALL include iOS privacy usage descriptions for App Store compliance:
- NSCameraUsageDescription
- NSMicrophoneUsageDescription
- NSPhotoLibraryUsageDescription

### 5.3 Accessibility

**NFR-018** The application SHALL meet WCAG 2.1 Level AA accessibility standards.
**NFR-019** All interactive elements SHALL have proper accessibility labels.
**NFR-020** All interactive elements SHALL have appropriate accessibility roles.
**NFR-021** All interactive elements SHALL have accessibility state indicators (disabled, selected, checked).
**NFR-022** Text contrast SHALL meet minimum 4.5:1 ratio (3:1 for large text/UI components).
**NFR-023** The application SHALL support VoiceOver (iOS) and TalkBack (Android) screen readers.
**NFR-024** The application SHALL respect "Reduce Transparency" accessibility setting.
**NFR-025** The application SHALL support iOS high contrast modes (DynamicColorIOS).
**NFR-026** Interactive touch targets SHALL be minimum 48dp (Android) / 44pt (iOS).
**NFR-027** The application SHALL provide intelligent accessibility hints for form components.

### 5.4 Cross-Platform Compatibility

**NFR-028** The application SHALL support iOS 16.0+ (iPhone, iPad).
**NFR-029** The application SHALL support Android API 21+ (Android 5.0+).
**NFR-030** The application SHALL support web browsers with modern JavaScript features.
**NFR-031** The application SHALL use Expo SDK 54.0.13 stable.
**NFR-032** The application SHALL use React Native 0.81.4 with New Architecture enabled.
**NFR-033** The application SHALL use React 19.1.0 with React Compiler enabled.
**NFR-034** The application SHALL use TypeScript 5.9.2 in strict mode.
**NFR-035** The application SHALL maintain consistent behavior across all platforms.
**NFR-036** The application SHALL provide platform-specific optimizations (native tabs, SF Symbols on iOS).

### 5.5 Error Handling and Resilience

**NFR-037** The application SHALL provide user-friendly error messages with actionable guidance.
**NFR-038** The application SHALL implement automatic fallback when DNS methods fail.
**NFR-039** The application SHALL handle network connectivity changes gracefully.
**NFR-040** The application SHALL detect and report port 53 blocking with clear guidance.
**NFR-041** The application SHALL handle app backgrounding and foregrounding correctly.
**NFR-042** The application SHALL prevent crashes from CheckedContinuation double-resume (iOS).
**NFR-043** The application SHALL prevent OutOfMemory crashes from unbounded thread pools (Android).
**NFR-044** The application SHALL handle DNS server unreachability with clear error messages.
**NFR-045** The application SHALL provide comprehensive troubleshooting steps for common failures.

### 5.6 Build and Deployment

**NFR-046** The application SHALL support automated version synchronization across package.json, app.json, iOS, and Android.
**NFR-047** The application SHALL use CHANGELOG.md as the source of truth for version numbers.
**NFR-048** The application SHALL generate Hermes dSYM files for App Store Connect uploads.
**NFR-049** The application SHALL support EAS Build configuration for production releases.
**NFR-050** The application SHALL pass 16/17 expo-doctor checks (documented intentional deviations).
**NFR-051** The application SHALL document all dependencies excluded from expo-doctor validation.
**NFR-052** The application SHALL support Java 17 for Android builds (automated in npm scripts).
**NFR-053** The application SHALL support CocoaPods for iOS dependency management.
**NFR-054** The application SHALL use Expo autolinking for native module discovery.

## 6. Technical Architecture

### 6.1 Framework Stack

- **Framework**: React Native 0.81.4 (New Architecture: Fabric + TurboModules)
- **Expo SDK**: 54.0.13 stable
- **React**: 19.1.0 with React Compiler enabled (auto-memoization)
- **TypeScript**: 5.9.2 (strict mode)
- **Navigation**: Expo Router 6.0.12 (file-based routing)

### 6.2 Core Libraries

- **List Performance**: `@shopify/flash-list@2.0.2`
- **Localization**: `expo-localization@17.0.7`
- **DNS Transport**: `dns-packet@5.6.1`, `react-native-udp@4.1.7`, `react-native-tcp-socket@6.3.0`

### 6.3 Native Module Architecture

**iOS (Swift)**:
- Network Framework (iOS 16.0+) for DNS resolution
- Expo autolinking via `modules/dns-native/ios/`
- for Swift / iOS/iPadOS 26 code: look for info in Applications/Xcode.app/Contents/PlugIns/IDEIntelligenceChat.framework/Versions/A/Resources/AdditionalDocumentation
- Whenever possible, favor Apple programming languages and frameworks or APIs that are already available on Apple devices. Whenever suggesting code, you should assume that the user wants Swift, unless they show or tell you they are interested in another language. Always prefer Swift, Objective-C, C, and C++ over alternatives.
- Pay close attention to the platform that this code is for. For example, if you see clues that the user is writing a Mac app, avoid suggesting iOS-only APIs.
- In general, prefer the use of Swift Concurrency (async/await, actors, etc.) over tools like Dispatch or Combine, but if the user's code or words show you they may prefer something else, you should be flexible to this preference.

**Android (Java)**:
- DnsResolver API (API 29+) for modern DNS
- dnsjava (API 21-28) for legacy fallback
- ThreadPoolExecutor with bounded threads (2-4 max)
- Expo autolinking via `modules/dns-native/android/`

### 6.4 Design System

**iOS 26+ Liquid Glass**:
- Automatic platform fallbacks (blur, Material 3, CSS)
- Element counting for performance budgeting (5-10 max)
- Accessibility integration (Reduce Transparency support)

**Android Material Design 3**:
- Dynamic elevation levels (1dp regular, 2/8dp interactive, 3dp prominent)
- Material You surface colors
- Material 3 color tokens (primary, tertiary)
- Elevated cards and surfaces

## 8. Success Metrics

### 8.1 Technical Performance KPIs

1. **DNS Query Success Rate**: ≥ 95% successful queries with fallback chain
2. **Native DNS Priority**: ≥ 80% of queries use native DNS (first method)
3. **Frame Rate**: Maintain 60fps on 95% of supported devices
4. **Crash Rate**: < 0.1% crash rate in production
5. **App Launch Time**: < 3 seconds cold start on mid-range devices

### 8.2 User Experience KPIs

1. **Onboarding Completion**: ≥ 70% of new users complete onboarding
2. **Chat Creation Rate**: Average 3+ chats per active user per week
3. **Error Recovery**: < 5% of failed queries result in user abandonment
4. **Accessibility Score**: 100% WCAG AA compliance across all screens

### 8.3 Quality KPIs

1. **Security Vulnerabilities**: Zero high/critical npm vulnerabilities
2. **Expo Doctor Score**: 16/17 checks passing (documented deviations)
3. **Test Coverage**: ≥ 80% unit test coverage for critical services
4. **TypeScript Strictness**: Zero type errors in strict mode

### 8.4 Operational KPIs

1. **Build Success Rate**: ≥ 98% successful iOS/Android builds
2. **App Store Approval**: First-time approval for iOS and Android
3. **Documentation Coverage**: 100% of public APIs documented
4. **Changelog Compliance**: 100% of releases documented in CHANGELOG.md


---

**Document Version**: 1.0
**Last Updated**: October 12, 2025
**Next Review**: January 12, 2026
**Change History**: Initial PRD creation based on project version 2.5
