name: ci

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20.19.4

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2
        with:
          bun-version: 1.3.9

      - name: Install
        run: bun ci

      - name: Verify iOS pods lockfile sync
        run: bun run verify:ios-pods

      - name: Verify Expo Doctor
        run: bun run verify:expo-doctor

      - name: Verify SDK alignment
        run: bun run verify:sdk-alignment

      - name: Verify typed routes generation
        run: bun run verify:typed-routes

      - name: Verify DNSResolver sync
        run: bun run verify:dnsresolver-sync

      - name: Verify React Compiler health
        run: bun run verify:react-compiler

      - name: Lint
        run: bun run lint

      - name: Test
        run: bun run test -- --bail --passWithNoTests

  dns-native:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20.19.4

      - name: Install (modules/dns-native)
        working-directory: modules/dns-native
        run: npm ci

      - name: Test (modules/dns-native)
        working-directory: modules/dns-native
        run: npm test

  android:
    runs-on: ubuntu-latest
    timeout-minutes: 75
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Java 17
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20.19.4

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: bun ci

      - name: Ensure debug keystore
        working-directory: android/app
        run: |
          if [ ! -f debug.keystore ]; then
            keytool -genkeypair -v \
              -storetype PKCS12 \
              -keystore debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi

      # Gradle wrapper validation prevents supply chain attacks via modified wrapper
      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@45b52564f44a4a311f3e621e74c7c97dd0c5696a # v4

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@45b52564f44a4a311f3e621e74c7c97dd0c5696a # v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      # Debug build verifies the build configuration works
      - name: Gradle assembleDebug
        working-directory: android
        run: ./gradlew :app:assembleDebug --no-daemon --warning-mode=summary

      # Release build verifies signing config (produces unsigned APK without creds)
      - name: Gradle assembleRelease
        working-directory: android
        run: ./gradlew :app:assembleRelease --no-daemon --warning-mode=summary

      - name: Verify Android 16KB page-size alignment
        run: bun run verify:android-16kb

  sbom:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20.19.4

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2
        with:
          bun-version: 1.3.9

      - name: Install
        run: bun ci

      - name: Resolve version
        id: version
        run: echo "version=$(jq -r '.version' package.json)" >> "$GITHUB_OUTPUT"

      - name: Prepare SBOM output
        run: mkdir -p artifacts/sbom

      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0
        with:
          path: .
          format: cyclonedx-json
          output-file: artifacts/sbom/${{ steps.version.outputs.version }}.json
          upload-artifact: false

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sbom-${{ steps.version.outputs.version }}
          path: artifacts/sbom/${{ steps.version.outputs.version }}.json
